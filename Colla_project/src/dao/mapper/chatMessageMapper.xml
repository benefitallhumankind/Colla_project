<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dao.ChatMessageDao">
	<insert id="insertChatMessage" parameterType="chatMessage">
		<selectKey resultType="int" keyProperty="cmNum" order="BEFORE">
			select cm_seq.nextval from dual
		</selectKey>
		insert into chat_message(cm_num,cr_num,m_num,cm_content,cm_type)
		values(#{cmNum},#{crNum},#{mNum},#{cmContent},#{cmType})
	</insert>
	<delete id="deleteChatMessage" parameterType="int">
		delete chat_message where cm_num=#{cmNum}
	</delete>
	<select id="selectChatMessageByCmNum" parameterType="int" resultMap="cmMap">
		select cm.cm_num,cm.cr_num,cm.m_num,cm.cm_content,cm.cm_write_date, m.m_name, cm.cm_type, m.m_profileimg
		from chat_message cm,member m
		where cm.m_num=m.m_num and cm_num=#{cmNum}
	</select>
	<select id="selectAllChatMessageByCrNum" resultMap="cmMap">
		select a.cm_num  ,a.cr_num,a.m_num,a.cm_content,a.cm_write_date,a.m_name,a.cm_type,a.m_profileimg, f.f_num
		from (select cm.cm_num  ,cm.cr_num,cm.m_num,cm.cm_content,cm.cm_write_date,m.m_name,cm.cm_type,m.m_profileimg
        		from chat_message cm, member m 
        		where cm.m_num=m.m_num and cm.cr_num=#{param1}) a left outer join favorite f
		on f.cm_num = a.cm_num and f.m_num=#{param2}
		order by a.cm_write_date asc
	</select>
	<!-- 채팅방 즐겨찾기 추가/삭제/조회 -->
	<insert id="insertFavorite">
		insert into favorite
		values(f_seq.nextval, #{param1}, #{param2})
	</insert>
	<delete id="deleteFavorite">
		delete
		from favorite
		where cm_num = #{param1}
	</delete>
	<select id="selectChatFavoriteList" resultMap="cmMap">
		select cm.cm_num  ,cm.cr_num,cm.m_num,cm.cm_content,cm.cm_write_date,m.m_name,cm.cm_type,m.m_profileimg,f.f_num
		from chat_message cm, member m, favorite f 
		where cm.m_num=m.m_num and cm.cr_num=#{param1} and cm.cm_num = f.cm_num and f.m_num=#{param2}
		order by cm.cm_write_date asc
	</select>
	<resultMap type="chatMessage" id="cmMap">
		<result column="cr_num" property="crNum"/>
		<result column="cm_num" property="cmNum"/>
		<result column="m_num" property="mNum"/>
		<result column="cm_content" property="cmContent"/>
		<result column="cm_write_date" property="cmWriteDate"/>
		<result column="m_name" property="mName"/>
		<result column="m_profileimg" property="profileImg"/>
		<result column="cm_type" property="cmType"/>
		<result column="f_num" property="isFavorite"/>
	</resultMap>
</mapper>